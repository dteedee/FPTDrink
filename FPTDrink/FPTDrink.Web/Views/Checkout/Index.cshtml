@model FPTDrink.Web.ViewModels.CheckoutViewModel
@{
	ViewData["Title"] = "Thanh toán";
	var cart = (FPTDrink.Web.ViewModels.CartViewModel)ViewBag.Cart;
	var total = cart.Items.Sum(i => i.TotalPrice);
}

<section class="products-section checkout-section">
	<div class="section-header">
		<h2><i class="bx bx-credit-card"></i>Thanh toán</h2>
		<p class="mb-0">Vui lòng điền thông tin để hoàn tất đơn hàng</p>
	</div>

	<div class="row g-4">
		<div class="col-12 col-lg-7">
			<div class="card border-0 shadow-sm checkout-form-card">
				<div class="card-body p-4">
					<form method="post" id="checkout-form">
						<div class="row g-3">
							<div class="col-md-6">
								<label class="form-label fw-bold" style="color: #2d1b0e;">
									Họ tên <span class="text-danger">*</span>
									<span class="field-error text-danger small ms-2" data-field="TenKhachHang"></span>
								</label>
								<input asp-for="TenKhachHang" class="form-control checkout-input" placeholder="Nhập họ tên" />
								<span asp-validation-for="TenKhachHang" class="text-danger small"></span>
							</div>
							<div class="col-md-6">
								<label class="form-label fw-bold" style="color: #2d1b0e;">
									Số điện thoại <span class="text-danger">*</span>
									<span class="field-error text-danger small ms-2" data-field="SoDienThoai"></span>
								</label>
								<input asp-for="SoDienThoai" 
								       type="tel" 
								       inputmode="numeric" 
								       pattern="[0-9]*" 
								       class="form-control checkout-input" 
								       placeholder="Nhập số điện thoại" 
								       maxlength="10" />
								<span asp-validation-for="SoDienThoai" class="text-danger small"></span>
							</div>
							<div class="col-md-12">
								<label class="form-label fw-bold" style="color: #2d1b0e;">
									Email
									<span class="field-error text-danger small ms-2" data-field="Email"></span>
								</label>
								<input asp-for="Email" type="email" class="form-control checkout-input" placeholder="Nhập email" />
								<span asp-validation-for="Email" class="text-danger small"></span>
							</div>
							<div class="col-md-12">
								<label class="form-label fw-bold" style="color: #2d1b0e;">
									Địa chỉ <span class="text-danger">*</span>
									<span class="field-error text-danger small ms-2" data-field="DiaChi"></span>
								</label>
								<input asp-for="DiaChi" class="form-control checkout-input" placeholder="Nhập địa chỉ" />
								<span asp-validation-for="DiaChi" class="text-danger small"></span>
							</div>
							<div class="col-md-12">
								<label class="form-label fw-bold" style="color: #2d1b0e;">Hình thức thanh toán</label>
								<select asp-for="TypePayment" class="form-select checkout-select">
									<option value="1">COD (Thanh toán khi nhận hàng)</option>
									<option value="2">VNPay (Trực tuyến)</option>
									<option value="3">Trực tiếp</option>
								</select>
							</div>
						</div>
						<div class="mt-4 text-end">
							<button type="submit" class="btn btn-primary btn-lg checkout-submit-btn">
								<i class="bx bx-check me-2"></i>Đặt hàng
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<div class="col-12 col-lg-5">
			<div class="card border-0 shadow-sm order-summary-card">
				<div class="card-header checkout-card-header">
					<h3 class="mb-0 fw-bold" style="color: #2d1b0e;"><i class="bx bx-cart me-2"></i>Đơn hàng</h3>
				</div>
				<div class="card-body">
					@foreach (var item in cart.Items)
					{
						<div class="d-flex align-items-center justify-content-between py-3 border-bottom checkout-item">
							<div class="d-flex align-items-center gap-3">
								<img src="@(string.IsNullOrWhiteSpace(item.ProductImg) ? Url.Content("~/images/placeholder.png") : item.ProductImg)" 
								     class="rounded object-fit-cover checkout-item-image" />
								<div>
									<div class="fw-bold" style="color: #2d1b0e;">@item.ProductName</div>
									<div class="small text-muted">x @item.Quantity</div>
								</div>
							</div>
							<div class="fw-bold" style="color: #2d1b0e;">@string.Format("{0:N0} ₫", item.TotalPrice)</div>
						</div>
					}
				</div>
				<div class="card-footer checkout-card-footer">
					<div class="d-flex justify-content-between align-items-center">
						<div class="fw-bold" style="color: #2d1b0e; font-size: 1.1rem;">Tổng cộng</div>
						<div class="fw-bold" style="color: #d4a574; font-size: 1.5rem;">@string.Format("{0:N0} ₫", total)</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

@section Styles {
	<style>
		.checkout-section {
			padding: 2rem 0;
		}

		.checkout-form-card,
		.order-summary-card {
			background: linear-gradient(135deg, #faf8f5 0%, #f5f0e8 100%);
			border: 2px solid rgba(212, 165, 116, 0.25) !important;
			border-radius: 16px;
		}

		.checkout-input,
		.checkout-select {
			border: 2px solid rgba(212, 165, 116, 0.3);
			border-radius: 10px;
			background: #ffffff;
			color: #2d1b0e;
			padding: 12px 16px;
			transition: all 0.3s ease;
		}

		.checkout-input:focus,
		.checkout-select:focus {
			border-color: #d4a574;
			box-shadow: 0 0 0 0.2rem rgba(212, 165, 116, 0.25);
			background: #ffffff;
			color: #2d1b0e;
		}

		.checkout-input.is-invalid,
		.checkout-select.is-invalid {
			border-color: #dc3545;
		}

		.checkout-input.is-valid,
		.checkout-select.is-valid {
			border-color: #28a745;
		}

		.checkout-card-header {
			background: linear-gradient(135deg, rgba(212, 165, 116, 0.1) 0%, rgba(139, 90, 43, 0.05) 100%);
			border-bottom: 2px solid rgba(212, 165, 116, 0.25);
			padding: 1.25rem;
		}

		.checkout-card-footer {
			background: linear-gradient(135deg, rgba(212, 165, 116, 0.1) 0%, rgba(139, 90, 43, 0.05) 100%);
			border-top: 2px solid rgba(212, 165, 116, 0.25);
			padding: 1.25rem;
		}

		.checkout-item {
			border-color: rgba(212, 165, 116, 0.2) !important;
		}

		.checkout-item-image {
			height: 50px;
			width: 50px;
			object-fit: cover;
			border: 2px solid rgba(212, 165, 116, 0.3);
		}

		.checkout-submit-btn {
			background: linear-gradient(135deg, #d4a574 0%, #f0c896 100%) !important;
			border: none !important;
			color: #1a0f08 !important;
			font-weight: 700;
			border-radius: 10px;
			padding: 14px 32px;
			transition: all 0.3s ease;
			box-shadow: 0 4px 12px rgba(212, 165, 116, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
			letter-spacing: 0.3px;
			position: relative;
			overflow: hidden;
		}

		.checkout-submit-btn::before {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			width: 0;
			height: 0;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.3);
			transform: translate(-50%, -50%);
			transition: width 0.4s ease, height 0.4s ease;
		}

		.checkout-submit-btn:hover::before {
			width: 300px;
			height: 300px;
		}

		.checkout-submit-btn:hover:not(:disabled) {
			transform: translateY(-3px);
			box-shadow: 0 8px 24px rgba(212, 165, 116, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.4);
			background: linear-gradient(135deg, #f0c896 0%, #d4a574 100%) !important;
		}

		.checkout-submit-btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}

		.field-error {
			display: none;
		}

		.field-error.show {
			display: inline;
		}
	</style>
}

@section Scripts {
	<partial name="_ValidationScriptsPartial" />
	<script>
		(function() {
			const form = document.getElementById('checkout-form');
			if (!form) return;

			const phoneInput = form.querySelector('[name="SoDienThoai"]');
			const emailInput = form.querySelector('[name="Email"]');
			const nameInput = form.querySelector('[name="TenKhachHang"]');
			const addressInput = form.querySelector('[name="DiaChi"]');

			function validatePhone(phone) {
				if (!phone) {
					return 'Số điện thoại là bắt buộc';
				}
				if (!/^\d+$/.test(phone)) {
					return 'Số điện thoại chỉ được chứa số';
				}
				if (phone.length !== 10) {
					return 'Số điện thoại phải có đúng 10 số';
				}
				if (phone[0] !== '0') {
					return 'Số điện thoại phải bắt đầu bằng 0';
				}
				if (phone[1] === '0') {
					return 'Số thứ 2 phải khác 0';
				}
				return '';
			}

			function validateEmail(email) {
				if (!email) {
					return '';
				}
				var atSymbol = String.fromCharCode(64);
				if (email.indexOf(atSymbol) === -1) {
					return 'Email phải có ký tự @@';
				}
				if (/[àáảãạăắằẳẵặâấầẩẫậèéẻẽẹêếềểễệìíỉĩịòóỏõọôốồổỗộơớờởỡợùúủũụưứừửữựỳýỷỹỵđ]/.test(email)) {
					return 'Email không được chứa dấu';
				}
				var emailPattern = '^[a-zA-Z0-9._%+-]+' + atSymbol + '[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$';
				var emailRegex = new RegExp(emailPattern);
				if (!emailRegex.test(email)) {
					return 'Email không đúng định dạng';
				}
				return '';
			}

			function validateName(name) {
				if (!name || name.trim() === '') {
					return 'Họ tên là bắt buộc';
				}
				return '';
			}

			function showError(fieldName, message) {
				const errorSpan = form.querySelector(`[data-field="${fieldName}"]`);
				const input = form.querySelector(`[name="${fieldName}"]`);
				if (errorSpan) {
					errorSpan.textContent = message;
					errorSpan.classList.add('show');
				}
				if (input) {
					input.classList.add('is-invalid');
					input.classList.remove('is-valid');
				}
			}

			function clearError(fieldName, showValid) {
				const errorSpan = form.querySelector(`[data-field="${fieldName}"]`);
				const input = form.querySelector(`[name="${fieldName}"]`);
				if (errorSpan) {
					errorSpan.textContent = '';
					errorSpan.classList.remove('show');
				}
				if (input) {
					input.classList.remove('is-invalid');
					if (showValid === true && input.value && input.value.trim() !== '') {
						input.classList.add('is-valid');
					} else {
						input.classList.remove('is-valid');
					}
				}
			}

			function resetField(fieldName) {
				const errorSpan = form.querySelector(`[data-field="${fieldName}"]`);
				const input = form.querySelector(`[name="${fieldName}"]`);
				if (errorSpan) {
					errorSpan.textContent = '';
					errorSpan.classList.remove('show');
				}
				if (input) {
					input.classList.remove('is-invalid');
					input.classList.remove('is-valid');
				}
			}

			if (phoneInput) {
				phoneInput.addEventListener('keypress', function(e) {
					const char = String.fromCharCode(e.which || e.keyCode);
					if (!/[0-9]/.test(char)) {
						e.preventDefault();
						return false;
					}
				});

				phoneInput.addEventListener('input', function() {
					this.value = this.value.replace(/[^0-9]/g, '');
					resetField('SoDienThoai');
				});

				phoneInput.addEventListener('paste', function(e) {
					e.preventDefault();
					const paste = (e.clipboardData || window.clipboardData).getData('text');
					const numbersOnly = paste.replace(/[^0-9]/g, '');
					this.value = numbersOnly;
					resetField('SoDienThoai');
				});

				phoneInput.addEventListener('blur', function() {
					const value = this.value;
					const error = validatePhone(value);
					if (error) {
						showError('SoDienThoai', error);
					} else if (value && value.trim() !== '') {
						clearError('SoDienThoai', true);
					} else {
						resetField('SoDienThoai');
					}
				});
			}

			if (emailInput) {
				emailInput.addEventListener('input', function() {
					resetField('Email');
				});

				emailInput.addEventListener('blur', function() {
					const value = this.value;
					if (value && value.trim() !== '') {
						const error = validateEmail(value);
						if (error) {
							showError('Email', error);
						} else {
							clearError('Email', true);
						}
					} else {
						resetField('Email');
					}
				});
			}

			function validateAddress(address) {
				if (!address || address.trim() === '') {
					return 'Địa chỉ là bắt buộc';
				}
				return '';
			}

			if (nameInput) {
				nameInput.addEventListener('input', function() {
					resetField('TenKhachHang');
				});

				nameInput.addEventListener('blur', function() {
					const value = this.value;
					const error = validateName(value);
					if (error) {
						showError('TenKhachHang', error);
					} else if (value && value.trim() !== '') {
						clearError('TenKhachHang', true);
					} else {
						resetField('TenKhachHang');
					}
				});
			}

			if (addressInput) {
				addressInput.addEventListener('input', function() {
					resetField('DiaChi');
				});

				addressInput.addEventListener('blur', function() {
					const value = this.value;
					const error = validateAddress(value);
					if (error) {
						showError('DiaChi', error);
					} else if (value && value.trim() !== '') {
						clearError('DiaChi', true);
					} else {
						resetField('DiaChi');
					}
				});
			}

			form.addEventListener('submit', function(e) {
				let hasError = false;

				if (nameInput) {
					const nameError = validateName(nameInput.value);
					if (nameError) {
						showError('TenKhachHang', nameError);
						hasError = true;
					}
				}

				if (phoneInput) {
					const phoneError = validatePhone(phoneInput.value);
					if (phoneError) {
						showError('SoDienThoai', phoneError);
						hasError = true;
					}
				}

				if (emailInput && emailInput.value) {
					const emailError = validateEmail(emailInput.value);
					if (emailError) {
						showError('Email', emailError);
						hasError = true;
					}
				}

				if (addressInput) {
					const addressError = validateAddress(addressInput.value);
					if (addressError) {
						showError('DiaChi', addressError);
						hasError = true;
					}
				}

				if (hasError) {
					e.preventDefault();
					return false;
				}
			});
		})();
	</script>
}

