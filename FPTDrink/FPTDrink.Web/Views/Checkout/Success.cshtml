@model FPTDrink.Web.ViewModels.OrderDetailViewModel?
@{
	ViewData["Title"] = "Đặt hàng thành công";
	var orderCode = Model?.MaHoaDon ?? (string?)ViewBag.OrderCode ?? "";
}

<section class="checkout-success-section">
	<div class="container">
		<div class="row justify-content-center">
			<div class="col-lg-10">
				<div class="success-card">
					<div class="success-header">
						<div class="success-icon">
							<i class="bx bx-check"></i>
						</div>
						<div>
							<h2>Cảm ơn bạn đã đặt hàng!</h2>
							<p class="mb-0">Đơn hàng #@orderCode đã được tạo thành công.</p>
						</div>
					</div>

					@if (Model != null)
					{
						<div class="row g-4 mt-1">
							<div class="col-md-6">
								<div class="info-card">
									<h5 class="info-title"><i class="bx bx-user me-2"></i>Thông tin khách hàng</h5>
									<ul class="info-list">
										<li><span>Họ tên:</span> <strong>@Model.TenKhachHang</strong></li>
										<li><span>Số điện thoại:</span> <strong>@Model.SoDienThoai</strong></li>
										@if (!string.IsNullOrWhiteSpace(Model.Email))
										{
											<li><span>Email:</span> <strong>@Model.Email</strong></li>
										}
										<li><span>Địa chỉ giao hàng:</span> <strong>@Model.DiaChi</strong></li>
									</ul>
								</div>
							</div>
							<div class="col-md-6">
								<div class="info-card">
									<h5 class="info-title"><i class="bx bx-receipt me-2"></i>Thông tin đơn hàng</h5>
									<ul class="info-list">
										<li><span>Mã đơn:</span> <strong>@Model.MaHoaDon</strong></li>
										<li><span>Ngày đặt:</span> <strong>@Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")</strong></li>
										<li><span>Hình thức thanh toán:</span> <strong>@Model.PaymentMethodName</strong></li>
										<li><span>Trạng thái:</span> <strong>@Model.TrangThaiHienThi</strong></li>
									</ul>
								</div>
							</div>
						</div>

						<div class="order-items-card mt-4">
							<h5 class="info-title"><i class="bx bx-box me-2"></i>Sản phẩm trong đơn</h5>
							<div class="table-responsive">
								<table class="table align-middle">
									<thead>
										<tr>
											<th>Sản phẩm</th>
											<th class="text-center">Số lượng</th>
											<th class="text-center">Đơn giá</th>
											<th class="text-center">Giảm</th>
											<th class="text-end">Thành tiền</th>
										</tr>
									</thead>
									<tbody>
										@foreach (var item in Model.ChiTietHoaDons)
										{
											var img = string.IsNullOrWhiteSpace(item.Product?.Image)
												? Url.Content("~/images/placeholder.png")
												: (item.Product.Image.StartsWith("http", StringComparison.OrdinalIgnoreCase)
													? item.Product.Image
													: Url.Content(item.Product.Image));
											<tr>
												<td>
													<div class="d-flex align-items-center gap-3">
														<img src="@img" alt="@item.Product?.Title" class="order-item-thumb" />
														<div>
															<div class="fw-semibold text-dark">@((item.Product != null && !string.IsNullOrWhiteSpace(item.Product.Title)) ? item.Product.Title : item.ProductId)</div>
															<div class="text-muted small">Mã: @item.ProductId</div>
														</div>
													</div>
												</td>
												<td class="text-center fw-semibold">@item.SoLuong</td>
												<td class="text-center">@string.Format("{0:N0} ₫", item.GiaBan)</td>
												<td class="text-center">@((item.GiamGia > 0 ? $"{item.GiamGia}%" : "-"))</td>
												<td class="text-end fw-semibold text-brown">@string.Format("{0:N0} ₫", item.ThanhTien)</td>
											</tr>
										}
									</tbody>
								</table>
							</div>

							<div class="order-total-box">
								<div class="d-flex justify-content-between align-items-center">
									<span class="total-label">Tổng cộng</span>
									<span class="total-amount">@string.Format("{0:N0} ₫", Model.TongTien)</span>
								</div>
								@if (!string.IsNullOrWhiteSpace(Model.Email))
								{
									<div class="mt-3 text-end">
										<button type="button"
										        class="btn btn-outline-primary btn-coffee-outline"
										        id="btnSendInvoice"
										        data-order="@Model.MaHoaDon"
										        data-email="@Model.Email">
											<i class="bx bx-mail-send me-2"></i>Gửi hoá đơn về email
										</button>
									</div>
									<div class="mt-2">
										<span id="sendInvoiceMessage" class="small text-muted"></span>
									</div>
								}
							</div>
						</div>

						@if (Model.PhuongThucThanhToan == 1)
						{
							<div class="alert alert-info mt-4">
								<i class="bx bx-package me-2"></i>Đơn hàng sẽ được giao trong vòng 30-60 phút. Vui lòng chuẩn bị tiền mặt để thanh toán khi nhận hàng.
							</div>
						}
						else if (Model.PhuongThucThanhToan == 3)
						{
							<div class="alert alert-warning mt-4">
								<i class="bx bx-store me-2"></i>Vui lòng đến cửa hàng trong vòng 24 giờ để nhận hàng và thanh toán.
							</div>
						}
					}
					else
					{
						<div class="alert alert-warning mt-4">
							Không tìm thấy chi tiết đơn hàng. Bạn có thể sử dụng mã <strong>@orderCode</strong> để tra cứu lại trong mục "Tra cứu đơn hàng".
						</div>
					}

					<div class="mt-4 d-flex gap-3 justify-content-center flex-wrap">
						<a class="btn btn-outline-primary btn-coffee-outline" asp-controller="Home" asp-action="Index">
							<i class="bx bx-home-alt me-2"></i>Quay về trang chủ
						</a>
						<a class="btn btn-primary btn-coffee" asp-controller="TraCuuDonHang" asp-action="Index">
							<i class="bx bx-search-alt me-2"></i>Tra cứu đơn hàng
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

@section Styles {
	<style>
		.checkout-success-section {
			padding: 3rem 0 4rem;
			background: linear-gradient(135deg, #fafafa 0%, #f5f0e8 100%);
		}

		.success-card {
			background: #ffffff;
			border-radius: 24px;
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
			padding: 2.5rem;
			border: 2px solid rgba(212, 165, 116, 0.25);
		}

		.success-header {
			display: flex;
			align-items: center;
			gap: 1.5rem;
			padding-bottom: 1.5rem;
			border-bottom: 2px dashed rgba(212, 165, 116, 0.3);
		}

		.success-icon {
			width: 72px;
			height: 72px;
			background: linear-gradient(135deg, rgba(212, 165, 116, 0.2), rgba(212, 165, 116, 0.4));
			color: #2d1b0e;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 2rem;
		}

		.success-card h2 {
			color: #2d1b0e;
			font-weight: 700;
		}

		.info-card {
			background: rgba(255, 255, 255, 0.9);
			border: 1px solid rgba(212, 165, 116, 0.25);
			border-radius: 16px;
			padding: 1.5rem;
			height: 100%;
		}

		.info-title {
			color: #2d1b0e;
			font-weight: 700;
			margin-bottom: 1rem;
		}

		.info-list {
			list-style: none;
			margin: 0;
			padding: 0;
		}

		.info-list li {
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 0.75rem;
			padding: 0.5rem 0;
			border-bottom: 1px dashed rgba(212, 165, 116, 0.25);
			color: #4b3b2a;
		}

		.info-list li:last-child {
			border-bottom: none;
		}

		.info-list span {
			color: #6f5a45;
		}

		.order-items-card {
			background: rgba(255, 255, 255, 0.95);
			border: 1px solid rgba(212, 165, 116, 0.25);
			border-radius: 16px;
			padding: 1.5rem;
		}

		.order-items-card .table thead th {
			color: #6f5a45;
			border-bottom: 2px solid rgba(212, 165, 116, 0.25);
		}

		.order-items-card .table tbody td {
			border-color: rgba(212, 165, 116, 0.15);
			vertical-align: middle;
			color: #2d1b0e;
		}

		.order-item-thumb {
			width: 60px;
			height: 60px;
			object-fit: cover;
			border-radius: 12px;
			border: 2px solid rgba(212, 165, 116, 0.3);
		}

		.order-total-box {
			margin-top: 1.5rem;
			padding-top: 1.5rem;
			border-top: 2px dashed rgba(212, 165, 116, 0.3);
		}

		.total-label {
			font-weight: 600;
			color: #2d1b0e;
			font-size: 1.1rem;
		}

		.total-amount {
			font-weight: 700;
			color: #d4a574;
			font-size: 1.75rem;
		}

		.text-brown {
			color: #2d1b0e;
		}

		@@media (max-width: 767.98px) {
			.success-card {
				padding: 1.75rem;
			}

			.success-header {
				flex-direction: column;
				align-items: flex-start;
				gap: 1rem;
			}

			.info-list li {
				flex-direction: column;
				align-items: flex-start;
			}

			.total-amount {
				font-size: 1.4rem;
			}
		}
	</style>
}

@section Scripts {
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const btn = document.getElementById('btnSendInvoice');
			if (!btn) return;

			const messageEl = document.getElementById('sendInvoiceMessage');
			const url = '@Url.Action("SendInvoice", "Checkout")';

			btn.addEventListener('click', async function () {
				const orderCode = btn.getAttribute('data-order');
				if (!orderCode) return;

				btn.disabled = true;
				btn.classList.add('disabled');
				if (messageEl) {
					messageEl.textContent = 'Đang gửi hoá đơn, vui lòng chờ...';
					messageEl.className = 'small text-muted';
				}

				try {
					const response = await fetch(url, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
						},
						body: new URLSearchParams({ orderCode })
					});

					const result = await response.json();
					if (result.success) {
						if (messageEl) {
							messageEl.textContent = result.message || 'Hoá đơn đã được gửi.';
							messageEl.className = 'small text-success';
						}
					} else {
						if (messageEl) {
							messageEl.textContent = result.message || 'Gửi hoá đơn thất bại. Vui lòng thử lại.';
							messageEl.className = 'small text-danger';
						}
						btn.disabled = false;
						btn.classList.remove('disabled');
					}
				} catch (error) {
					if (messageEl) {
						messageEl.textContent = 'Gửi hoá đơn thất bại. Vui lòng thử lại.';
						messageEl.className = 'small text-danger';
					}
					btn.disabled = false;
					btn.classList.remove('disabled');
				}
			});
		});
	</script>
}
